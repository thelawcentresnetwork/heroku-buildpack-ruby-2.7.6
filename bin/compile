#!/usr/bin/env bash
set -e

# Heroku passes these in
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

RUBY_VERSION="2.7.6"
INSTALL_DIR="$BUILD_DIR/.heroku/ruby"

echo "ðŸ‘‰ Cleaning up any old Ruby build"
rm -rf "$BUILD_DIR"/ruby-"$RUBY_VERSION"

echo "ðŸ‘‰ Installing Ruby $RUBY_VERSION into $INSTALL_DIR"

# Download & extract
curl -L "https://cache.ruby-lang.org/pub/ruby/2.7/ruby-$RUBY_VERSION.tar.gz" | tar xz
cd "ruby-$RUBY_VERSION"

# Configure/install into the build dir, not /
./configure \
  --prefix="$INSTALL_DIR" \
  --with-openssl-dir=/usr \
  --with-readline-dir=/usr \
  --with-zlib-dir=/usrmake -j$(nproc)

make -j$(nproc)
make install

# Ensure the Ruby bin folder is on PATH for subsequent buildpacks
mkdir -p "$BUILD_DIR"/.profile.d
cat <<'EOF' > "$BUILD_DIR"/.profile.d/ruby.sh
export PATH="$HOME/.heroku/ruby/bin:$PATH"
EOF

echo "âœ… Ruby $RUBY_VERSION installed"